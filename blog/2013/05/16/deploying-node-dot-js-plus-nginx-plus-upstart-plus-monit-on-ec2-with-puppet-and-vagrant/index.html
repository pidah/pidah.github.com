
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Deploying nodejs nginx upstart monit redis on ec2 with puppet and vagrant - My Octopress Blog</title>
  <meta name="author" content="Your Name">

  
  <meta name="description" content="Deploying node.js with nginx upstart monit redis on AWS ec2 cloud instances with vagrant">
  <meta name="keywords" content="puppet,vagrant,aws,ec2,redis,nginx,upstart,monit,ubuntu,linux,cloud,automation,deployment">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://pidah.github.io/blog/2013/05/16/deploying-node-dot-js-plus-nginx-plus-upstart-plus-monit-on-ec2-with-puppet-and-vagrant/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
   <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>


  

</head>

<body   >
  <header role="banner"><hgroup>
</hgroup>

</header>
  <!-- <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:pidah.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav> -->
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Deploying Nodejs Nginx Upstart Monit Redis on Ec2 With Puppet and Vagrant</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-16T18:02:00+01:00" pubdate data-updated="true">May 16<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In a previous post I wrote about <a href="http://www.devopsdiary.com/blog/2013/05/07/automated-deployment-of-aws-ec2-instances-with-vagrant-and-puppet/">automating deployments on AWS Cloud instances with vagrant and puppet</a>. Today I will be describing how we deploy Node.js with nginx,redis, upstart, monit on ec2 using vagrant and puppet.</p>

<p>Our developers are rewriting an existing application in Node.js and we basically needed a consistent environment to play with, which would mirror the target production environment as much as possible. So we picked out technology stack as follows:</p>

<ul>
<li>node.js &ndash; obviously</li>
<li>nginx   &ndash; As a reverse proxy server. We are using nginx 1.5.0 which has websocket support. You could also use the stable nginx version that comes with your linux distribution in combination with varnish or haproxy to handle websocket connection requests. If you are using nginx development builds, make sure you upgrade to nginx 1.5.0 or 1.4.1 to address the <a href="http://www.ehackingnews.com/2013/05/cve-2013-2028-buffer-overflow.html">recent buffer overflow vulnerability security issue</a>.</li>
<li>upstart &ndash; to daemonize the node app</li>
<li>monit &ndash; to proactively check that the app is actually humming nicely.</li>
<li>redis &ndash; for handling session data</li>
</ul>


<p>0ur approach is simply to start with a basic configuration which works well and fine-tune as we go along. The description below doesn&rsquo;t apply strictly to Node.js deployments; it could really be adapted for other web-apps/frameworks e.g. python/django/gunicorn behind nginx.</p>

<h2>Setup</h2>

<p>First of all clone the nodejs_deployment repo as follows:&ndash;</p>

<figure class='code'><figcaption><span>clone the node.js deployment repo</span><a href='https://github.com/pidah/nodejs_deployment'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>git clone git@github.com:pidah/nodejs_deployment.git
</span></code></pre></td></tr></table></div></figure>


<p>switch into the nodejs_deployment directory and have a look at the contents &ndash;</p>

<figure class='code'><figcaption><span>review the contents of nodejs_deployment</span><a href='https://github.com/pidah/nodejs_deployment'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>nodejs_deployment/
</span><span class='line'><span class="nv">$ </span>ls
</span><span class='line'>README.md Vagrantfile app.js      package.json    puppet
</span></code></pre></td></tr></table></div></figure>


<h2>Node.js app</h2>

<p>app.js shown below is a very simple node application listening on port 3000. The package.json file contains the node app dependencies. This app only depends on express.</p>

<figure class='code'><figcaption><span>node.js app</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/app.js'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat app.js
</span><span class='line'>var <span class="nv">express</span> <span class="o">=</span> require<span class="o">(</span><span class="s2">&quot;express&quot;</span><span class="o">)</span>;
</span><span class='line'>var <span class="nv">app</span> <span class="o">=</span> express<span class="o">()</span>;
</span><span class='line'>app.use<span class="o">(</span>express.logger<span class="o">())</span>;
</span><span class='line'>
</span><span class='line'>app.get<span class="o">(</span><span class="s1">&#39;/&#39;</span>, <span class="k">function</span><span class="o">(</span>request, response<span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  response.send<span class="o">(</span><span class="s1">&#39;My awesome node app!&#39;</span><span class="o">)</span>;
</span><span class='line'><span class="o">})</span>;
</span><span class='line'>
</span><span class='line'>var <span class="nv">port</span> <span class="o">=</span> process.env.PORT <span class="o">||</span> 3000;
</span><span class='line'>app.listen<span class="o">(</span>port, <span class="k">function</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  console.log<span class="o">(</span><span class="s2">&quot;Listening on &quot;</span> + port<span class="o">)</span>;
</span><span class='line'><span class="o">})</span>;
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat package.json
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;author&quot;</span>: <span class="s2">&quot;Peter Idah&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;awesome-app&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;version&quot;</span>: <span class="s2">&quot;0.0.1&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;dependencies&quot;</span>: <span class="o">{</span>
</span><span class='line'>    <span class="s2">&quot;express&quot;</span>: <span class="s2">&quot;~3.1.0&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Vagrantfile</h2>

<p> The Vagrantfile holds the vagrant configuration &ndash;</p>

<figure class='code'><figcaption><span>Vagrantfile</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/Vagrantfile'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntu_aws&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://github.com/mitchellh/vagrant-aws/raw/master/dummy.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;/vagrant&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="s2">&quot;vagrant-root&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:aws</span> <span class="k">do</span> <span class="o">|</span><span class="n">aws</span><span class="p">,</span> <span class="n">override</span><span class="o">|</span>
</span><span class='line'>    <span class="n">aws</span><span class="o">.</span><span class="n">keypair_name</span> <span class="o">=</span> <span class="s2">&quot;development&quot;</span>
</span><span class='line'>    <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">private_key_path</span> <span class="o">=</span> <span class="s2">&quot;~/.ssh/development.pem&quot;</span>
</span><span class='line'>    <span class="n">aws</span><span class="o">.</span><span class="n">instance_type</span> <span class="o">=</span> <span class="s2">&quot;t1.micro&quot;</span>
</span><span class='line'>    <span class="n">aws</span><span class="o">.</span><span class="n">security_groups</span> <span class="o">=</span> <span class="s2">&quot;development&quot;</span>
</span><span class='line'>    <span class="n">aws</span><span class="o">.</span><span class="n">ami</span> <span class="o">=</span> <span class="s2">&quot;ami-c5afc2ac&quot;</span>
</span><span class='line'>    <span class="n">override</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;ubuntu&quot;</span>
</span><span class='line'>    <span class="n">aws</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="s1">&#39;Name&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Nodejs App&#39;</span><span class="p">,</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:puppet</span> <span class="k">do</span> <span class="o">|</span><span class="n">puppet</span><span class="o">|</span>
</span><span class='line'>    <span class="n">puppet</span><span class="o">.</span><span class="n">manifests_path</span> <span class="o">=</span> <span class="s2">&quot;puppet/manifests&quot;</span>
</span><span class='line'>    <span class="n">puppet</span><span class="o">.</span><span class="n">manifest_file</span>  <span class="o">=</span> <span class="s2">&quot;init.pp&quot;</span>
</span><span class='line'>    <span class="n">puppet</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;--fileserverconfig=/vagrant/puppet/fileserver.conf&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The Vagrantfile will need to be updated with your AWS details. I am using a custom AMI with puppet baked in. Then you need to setup your AWS keys in your local ~/.profile file as follows</p>

<figure class='code'><figcaption><span>Configuring AWS Credentials in ~/.profile</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="nb">export </span><span class="nv">AWS_ACCESS_KEY</span><span class="o">=</span><span class="s2">&quot;AKXXXXXXXXXXXXXXX&quot;</span>
</span><span class='line'> <span class="nb">export </span><span class="nv">AWS_SECRET_KEY</span><span class="o">=</span><span class="s2">&quot;XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then source the ~/.profile to make the variables available in the current shell session</p>

<figure class='code'><figcaption><span>source the ~/.profile file</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="nb">source</span> ~/.profile
</span></code></pre></td></tr></table></div></figure>


<p>Every AWS EC2 instance would have an ssh key pair. I keep my ssh private key in  ~/.ssh/development.pem</p>

<p>For more details on the Vagrantfile, have a look at <a href="http://www.devopsdiary.com/blog/2013/05/07/automated-deployment-of-aws-ec2-instances-with-vagrant-and-puppet/">automated deployments of ec2 instances with vagrant and puppet</a>.</p>

<h2>puppet configuration overview</h2>

<p>The puppet configuration layout is shown below &ndash;</p>

<figure class='code'><figcaption><span>puppet manifests and files</span><a href='https://github.com/pidah/nodejs_deployment/tree/master/puppet/manifests'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ls puppet/manifests
</span><span class='line'>init.pp       nginx.pp    redis.pp
</span><span class='line'>monit.pp  nodejs.pp   upstart.pp
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat puppet/manifests/init.pp
</span><span class='line'>include nodejs
</span><span class='line'>include monit
</span><span class='line'>include nginx
</span><span class='line'>include upstart
</span><span class='line'>include redis
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ls puppet/files
</span><span class='line'>app.conf  deploy_node.sh  monitrc     nginx.conf
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat puppet/fileserver.conf
</span><span class='line'><span class="c"># Puppet template files directory</span>
</span><span class='line'><span class="o">[</span>files<span class="o">]</span>
</span><span class='line'>    path /opt/node/puppet/files
</span><span class='line'>    allow *
</span><span class='line'><span class="nv">$ </span>cat puppet/manifests/init.pp
</span></code></pre></td></tr></table></div></figure>


<p>Each component is in a seperate manitfest file. We include all of them init.pp as shown above. puppet/fileserver.conf tells puppet to serve files from our custom mount point /opt/node/puppet/files. More information on this is available on <a href="http://docs.puppetlabs.com/guides/file_serving.html">puppetlabs website</a>. Let&rsquo;s go through each manifest configuration file:</p>

<h2>node.js config</h2>

<p>The following shows the node.js puppet configuration files</p>

<figure class='code'><figcaption><span>node.js puppet configuration</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/puppet/manifests/nodejs.pp'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat puppet/manifests/nodejs.pp
</span><span class='line'>class nodejs <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    file <span class="o">{</span> <span class="s2">&quot;/opt/node&quot;</span>:
</span><span class='line'>        <span class="nv">ensure</span>  <span class="o">=</span>&gt; <span class="s2">&quot;link&quot;</span>,
</span><span class='line'>        <span class="nv">target</span>  <span class="o">=</span>&gt; <span class="s2">&quot;/vagrant&quot;</span>,
</span><span class='line'>        <span class="nv">force</span>   <span class="o">=</span>&gt; <span class="nb">true</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">exec</span> <span class="o">{</span> <span class="s2">&quot;apt-get update&quot;</span>:
</span><span class='line'>        <span class="nv">path</span> <span class="o">=</span>&gt; <span class="s2">&quot;/usr/bin&quot;</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; File<span class="o">[</span><span class="s2">&quot;/opt/node&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nv">$nodejs_deps</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;python-software-properties&quot;</span>, <span class="s2">&quot;g++&quot;</span>, <span class="s2">&quot;make&quot;</span>, <span class="s2">&quot;git&quot;</span>, <span class="s2">&quot;vim&quot;</span> <span class="o">]</span>
</span><span class='line'>        package <span class="o">{</span> <span class="nv">$nodejs_deps</span>:
</span><span class='line'>        <span class="nv">ensure</span> <span class="o">=</span>&gt; installed,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Exec<span class="o">[</span><span class="s2">&quot;apt-get update&quot;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    file <span class="o">{</span> <span class="s2">&quot;/tmp/deploy_node.sh&quot;</span>:
</span><span class='line'>        <span class="nv">ensure</span>  <span class="o">=</span>&gt; present,
</span><span class='line'>        <span class="nv">mode</span>    <span class="o">=</span>&gt; <span class="s1">&#39;0775&#39;</span>,
</span><span class='line'>        <span class="nb">source</span>  <span class="o">=</span>&gt; <span class="s2">&quot;puppet:///files/deploy_node.sh&quot;</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Package<span class="o">[</span><span class="nv">$nodejs_deps</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">exec</span> <span class="o">{</span> <span class="s2">&quot;install_node&quot;</span>:
</span><span class='line'>        <span class="nb">command</span> <span class="o">=</span>&gt; <span class="s2">&quot;/bin/bash /tmp/deploy_node.sh&quot;</span>,
</span><span class='line'>        <span class="nv">path</span> <span class="o">=</span>&gt; <span class="s2">&quot;/usr/bin:/usr/local/bin:/bin:/usr/sbin:/sbin&quot;</span>,
</span><span class='line'>        <span class="nv">timeout</span> <span class="o">=</span>&gt; 0,
</span><span class='line'>        <span class="nv">unless</span> <span class="o">=</span>&gt; <span class="s2">&quot;ls /usr/local/bin/node &quot;</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; File<span class="o">[</span><span class="s2">&quot;/tmp/deploy_node.sh&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">exec</span> <span class="o">{</span> <span class="s2">&quot;npm_install&quot;</span>:
</span><span class='line'>        <span class="nv">cwd</span> <span class="o">=</span>&gt; <span class="s2">&quot;/opt/node&quot;</span>,
</span><span class='line'>        <span class="nb">command</span> <span class="o">=</span>&gt; <span class="s2">&quot;npm install&quot;</span>,
</span><span class='line'>        <span class="nv">path</span> <span class="o">=</span>&gt; <span class="s2">&quot;/usr/bin:/usr/local/bin:/bin:/usr/sbin:/sbin&quot;</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Exec<span class="o">[</span><span class="s2">&quot;install_node&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat puppet/files/deploy_node.sh
</span><span class='line'><span class="c">#!/bin/bash -x</span>
</span><span class='line'><span class="nv">version</span><span class="o">=</span>0.10.5
</span><span class='line'>mkdir /tmp/nodejs <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="nv">$_</span>
</span><span class='line'>wget -N http://nodejs.org/dist/v<span class="k">${</span><span class="nv">version</span><span class="k">}</span>/node-v<span class="k">${</span><span class="nv">version</span><span class="k">}</span>.tar.gz
</span><span class='line'>tar xzvf node-v<span class="k">${</span><span class="nv">version</span><span class="k">}</span>.tar.gz <span class="o">&amp;&amp;</span> <span class="nb">cd </span>node-v<span class="k">${</span><span class="nv">version</span><span class="k">}</span>
</span><span class='line'>./configure
</span><span class='line'>make install
</span></code></pre></td></tr></table></div></figure>


<p>The app is deployed to /opt/node which is sym-linked to /vagrant on the ec2 instance. The node.js package provided by ubuntu is really old, so we decided to build node.js from source as shown in the deploy_node.sh file above. The make build takes longer than 5 minutes which is the default timeout for the puppet exec resource, so I set <code>timeout =&gt;0</code> in <code>exec {"install_node":}</code> above to prevent a timeout. Subsequent <code>vagrant provision</code> runs would just do a quick check to confirm that node is already installed. Alternatively you could use the node.js packages available at <a href="https://launchpad.net/~chris-lea/+archive/node.js/">https://launchpad.net/~chris-lea/+archive/node.js/</a></p>

<h2>upstart config</h2>

<figure class='code'><figcaption><span>upstart configuration file</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/puppet/files/app.conf'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat puppet/manifests/upstart.pp
</span><span class='line'>class upstart <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    file <span class="o">{</span> <span class="s2">&quot;/etc/init/app.conf&quot;</span>:
</span><span class='line'>        <span class="nv">ensure</span>  <span class="o">=</span>&gt; file,
</span><span class='line'>        <span class="nb">source</span>  <span class="o">=</span>&gt; <span class="s2">&quot;puppet:///files/app.conf&quot;</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Class<span class="o">[</span><span class="s2">&quot;Nodejs&quot;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    service <span class="o">{</span> <span class="s1">&#39;app&#39;</span>:
</span><span class='line'>        <span class="nv">ensure</span> <span class="o">=</span>&gt; running,
</span><span class='line'>        <span class="nv">provider</span> <span class="o">=</span>&gt; <span class="s1">&#39;upstart&#39;</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; File<span class="o">[</span><span class="s1">&#39;/etc/init/app.conf&#39;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="nv">$ </span>cat puppet/files/app.conf
</span><span class='line'>description <span class="s2">&quot;node.js app server&quot;</span>
</span><span class='line'>author      <span class="s2">&quot;Peter Idah&quot;</span>
</span><span class='line'>
</span><span class='line'>env <span class="nv">PROGRAM_NAME</span><span class="o">=</span><span class="s2">&quot;awesome-app&quot;</span>
</span><span class='line'>env <span class="nv">FULL_PATH</span><span class="o">=</span><span class="s2">&quot;/opt/node&quot;</span>
</span><span class='line'>env <span class="nv">FILE_NAME</span><span class="o">=</span><span class="s2">&quot;app.js&quot;</span>
</span><span class='line'>env <span class="nv">NODE_PATH</span><span class="o">=</span><span class="s2">&quot;/usr/local/bin/node&quot;</span>
</span><span class='line'>
</span><span class='line'>start on startup
</span><span class='line'>stop on shutdown
</span><span class='line'>
</span><span class='line'>script
</span><span class='line'>
</span><span class='line'>    <span class="nb">echo</span> <span class="nv">$$</span> &gt; /var/run/<span class="nv">$PROGRAM_NAME</span>.pid
</span><span class='line'>    <span class="nb">cd</span> <span class="nv">$FULL_PATH</span>
</span><span class='line'>    <span class="nb">exec</span> <span class="nv">$NODE_PATH</span> <span class="nv">$FULL_PATH</span>/<span class="nv">$FILE_NAME</span> &gt;&gt; <span class="nv">$FULL_PATH</span>/node_app.log 2&gt;&amp;1
</span><span class='line'>end script
</span><span class='line'>
</span><span class='line'>pre-start script
</span><span class='line'>    <span class="c"># Date format same as (new Date()).toISOString() for consistency</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Starting&quot;</span> &gt;&gt; <span class="nv">$FULL_PATH</span>/node_app.log
</span><span class='line'>end script
</span><span class='line'>
</span><span class='line'>pre-stop script
</span><span class='line'>    rm /var/run/<span class="nv">$PROGRAM_NAME</span>.pid
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Stopping&quot;</span> &gt;&gt; <span class="nv">$FULL_PATH</span>/node_app.log
</span><span class='line'>end script
</span></code></pre></td></tr></table></div></figure>


<p>The upstart.pp manifest above ensures the app is running with the configuration sourced from /etc/init/app.conf. This file daemonizes the application, specifies the process id location, logfile and the start/stop control scripts.</p>

<h2>monit config</h2>

<figure class='code'><figcaption><span>monit config file</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/puppet/files/monitrc'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat puppet/manifests/monit.pp
</span><span class='line'>class monit <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    package <span class="o">{</span> <span class="s2">&quot;monit&quot;</span>:
</span><span class='line'>        <span class="nv">ensure</span>  <span class="o">=</span>&gt; latest,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Class<span class="o">[</span><span class="s2">&quot;Nodejs&quot;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    file <span class="o">{</span> <span class="s1">&#39;/etc/monit/monitrc&#39;</span>:
</span><span class='line'>        <span class="nv">ensure</span>  <span class="o">=</span>&gt; present,
</span><span class='line'>        <span class="nv">mode</span>    <span class="o">=</span>&gt; <span class="s1">&#39;0600&#39;</span>,
</span><span class='line'>        <span class="nv">owner</span>   <span class="o">=</span>&gt; <span class="s1">&#39;root&#39;</span>,
</span><span class='line'>        <span class="nv">group</span>   <span class="o">=</span>&gt; <span class="s1">&#39;root&#39;</span>,
</span><span class='line'>        <span class="nb">source</span>  <span class="o">=</span>&gt; <span class="s2">&quot;puppet:///files/monitrc&quot;</span>,
</span><span class='line'>        <span class="nv">notify</span>  <span class="o">=</span>&gt; Service<span class="o">[</span><span class="s1">&#39;monit&#39;</span><span class="o">]</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Package<span class="o">[</span><span class="s2">&quot;monit&quot;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    service <span class="o">{</span> <span class="s1">&#39;monit&#39;</span>:
</span><span class='line'>        <span class="nv">ensure</span>     <span class="o">=</span>&gt; running,
</span><span class='line'>        <span class="nb">enable</span>     <span class="o">=</span>&gt; <span class="nb">true</span>,
</span><span class='line'>        <span class="nv">hasrestart</span> <span class="o">=</span>&gt; <span class="nb">true</span>,
</span><span class='line'>        <span class="nv">require</span>    <span class="o">=</span>&gt; File<span class="o">[</span><span class="s1">&#39;/etc/monit/monitrc&#39;</span><span class="o">]</span>,
</span><span class='line'>        <span class="nv">subscribe</span>  <span class="o">=</span>&gt; File<span class="o">[</span><span class="s1">&#39;/etc/monit/monitrc&#39;</span><span class="o">]</span>,
</span><span class='line'>        <span class="nv">notify</span>     <span class="o">=</span>&gt; Service<span class="o">[</span><span class="s1">&#39;app&#39;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat puppet/files/monitrc
</span><span class='line'><span class="c">#!monit</span>
</span><span class='line'><span class="nb">set </span>logfile /opt/node/monit_app.log
</span><span class='line'>
</span><span class='line'>check process nodejs with pidfile <span class="s2">&quot;/var/run/awesome-app.pid&quot;</span>
</span><span class='line'>    start <span class="nv">program</span> <span class="o">=</span> <span class="s2">&quot;/sbin/start app&quot;</span>
</span><span class='line'>    stop <span class="nv">program</span>  <span class="o">=</span> <span class="s2">&quot;/sbin/stop app&quot;</span>
</span><span class='line'>    <span class="k">if </span>failed port 3000 protocol HTTP
</span><span class='line'>        request /
</span><span class='line'>        with timeout 2 seconds
</span><span class='line'>        <span class="k">then </span>restart
</span><span class='line'>    <span class="k">if </span>cpu &gt; 80% <span class="k">for </span>10 cycles <span class="k">then </span>restart
</span><span class='line'>    <span class="k">if </span>3 restarts within 10 cycles <span class="k">then </span>timeout
</span></code></pre></td></tr></table></div></figure>


<p>The monit.pp manifest above ensures the latest monit package is installed and running. It will also trigger a restart if it detects changes to the contents of /etc/monit/monitrc config file. The monitrc config file sets the location of the monit log file, checks the process id and specifies the path to the start/stop scripts for the node app. Then it gets a bit more interesting with a few rules &ndash; in the 1st rule  monit checks if there is a failed request to the root of the node app listening on port 3000 for 2 seconds, monit will restart the application. The 2nd rule checks for cpu usage above 80% for 10 cpu cycles and trigers a restart of the app. There are several monit rules you can add, but that&rsquo;s the general idea.</p>

<h2>nginx config</h2>

<figure class='code'><figcaption><span>nginx config file</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/puppet/files/nginx.conf'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat puppet/manifests/nginx.pp
</span><span class='line'>class nginx <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">exec</span> <span class="o">{</span> <span class="s2">&quot;add_nginx_repo&quot;</span>:
</span><span class='line'>            <span class="nb">command</span> <span class="o">=</span>&gt; <span class="s2">&quot;add-apt-repository ppa:nginx/development --yes &amp;&amp; apt-get update &quot;</span>,
</span><span class='line'>            <span class="nv">path</span> <span class="o">=</span>&gt; <span class="s2">&quot;/usr/bin&quot;</span>,
</span><span class='line'>            <span class="nv">require</span> <span class="o">=</span>&gt; Class<span class="o">[</span>Nodejs<span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">exec</span> <span class="o">{</span> <span class="s2">&quot;install_nginx&quot;</span>:
</span><span class='line'>        <span class="nb">command</span> <span class="o">=</span>&gt; <span class="s2">&quot;/usr/bin/apt-get install nginx -y --force-yes&quot;</span>,
</span><span class='line'>        <span class="nv">path</span> <span class="o">=</span>&gt; <span class="s2">&quot;/usr/bin:/usr/local/bin:/bin:/usr/sbin:/sbin&quot;</span>,
</span><span class='line'>        <span class="nv">unless</span> <span class="o">=</span>&gt; <span class="s2">&quot;ls /usr/sbin/nginx &quot;</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Exec<span class="o">[</span><span class="s2">&quot;add_nginx_repo&quot;</span><span class="o">]</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    service <span class="o">{</span> <span class="s1">&#39;nginx&#39;</span>:
</span><span class='line'>        <span class="nv">ensure</span>     <span class="o">=</span>&gt; running,
</span><span class='line'>        <span class="nb">enable</span>     <span class="o">=</span>&gt; <span class="nb">true</span>,
</span><span class='line'>        <span class="nv">hasrestart</span> <span class="o">=</span>&gt; <span class="nb">true</span>,
</span><span class='line'>        <span class="nv">require</span>    <span class="o">=</span>&gt; Exec<span class="o">[</span><span class="s1">&#39;install_nginx&#39;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    file <span class="o">{</span> <span class="s2">&quot;/etc/nginx/nginx.conf&quot;</span>:
</span><span class='line'>        <span class="nv">ensure</span>  <span class="o">=</span>&gt; present,
</span><span class='line'>        <span class="nv">mode</span>    <span class="o">=</span>&gt; <span class="s1">&#39;0644&#39;</span>,
</span><span class='line'>        <span class="nb">source</span>  <span class="o">=</span>&gt; <span class="s2">&quot;puppet:///files/nginx.conf&quot;</span>,
</span><span class='line'>        <span class="nv">notify</span> <span class="o">=</span>&gt; Service<span class="o">[</span><span class="s1">&#39;nginx&#39;</span><span class="o">]</span>,
</span><span class='line'>        <span class="nv">require</span> <span class="o">=</span>&gt; Exec<span class="o">[</span><span class="s2">&quot;install_nginx&quot;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>cat puppet/files/nginx.conf
</span><span class='line'>user www-data;
</span><span class='line'>worker_processes 4;
</span><span class='line'>pid /var/run/nginx.pid;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>events <span class="o">{</span>
</span><span class='line'>        worker_connections 768;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>http <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c">##</span>
</span><span class='line'>        <span class="c"># Basic Settings</span>
</span><span class='line'>        <span class="c">##</span>
</span><span class='line'>
</span><span class='line'>        sendfile on;
</span><span class='line'>        tcp_nopush on;
</span><span class='line'>        tcp_nodelay on;
</span><span class='line'>        keepalive_timeout 65;
</span><span class='line'>        types_hash_max_size 2048;
</span><span class='line'>
</span><span class='line'>        include /etc/nginx/mime.types;
</span><span class='line'>        default_type application/octet-stream;
</span><span class='line'>
</span><span class='line'>        <span class="c">##</span>
</span><span class='line'>        <span class="c"># Logging Settings</span>
</span><span class='line'>        <span class="c">##</span>
</span><span class='line'>
</span><span class='line'>        access_log /var/log/nginx/access.log;
</span><span class='line'>        error_log /var/log/nginx/error.log;
</span><span class='line'>
</span><span class='line'>        <span class="c">##</span>
</span><span class='line'>        <span class="c"># Gzip Settings</span>
</span><span class='line'>        <span class="c">##</span>
</span><span class='line'>
</span><span class='line'>        gzip on;
</span><span class='line'>        gzip_disable <span class="s2">&quot;msie6&quot;</span>;
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        include /etc/nginx/conf.d/*.conf;
</span><span class='line'>
</span><span class='line'>upstream nodejs_backend <span class="o">{</span>
</span><span class='line'>    server 127.0.0.1:3000;
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># the nginx server instance</span>
</span><span class='line'>
</span><span class='line'>    server <span class="o">{</span>
</span><span class='line'>        listen 80 default;
</span><span class='line'>        server_name 127.0.0.1;
</span><span class='line'>        access_log /opt/node/nginx_app.log;
</span><span class='line'>
</span><span class='line'>    <span class="c"># pass the request to the node.js server with the correct headers</span>
</span><span class='line'>    location / <span class="o">{</span>
</span><span class='line'>        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span>;
</span><span class='line'>        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span>;
</span><span class='line'>        proxy_set_header Host <span class="nv">$http_host</span>;
</span><span class='line'>        proxy_set_header X-NginX-Proxy <span class="nb">true</span>;
</span><span class='line'>        proxy_pass http://nodejs_backend/;
</span><span class='line'>        proxy_redirect off;
</span><span class='line'>        proxy_http_version 1.1;
</span><span class='line'>        proxy_set_header Upgrade <span class="nv">$http_upgrade</span>;
</span><span class='line'>        proxy_set_header Connection <span class="s2">&quot;upgrade&quot;</span>;
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>
The nginx.pp manifest above installs nginx 1.5.0 from the nginx ppa development repo, ensures the service is running as specified in nginx.conf and would trigger a restart if changes are detected in nginx.conf.
The nginx.conf file above specifies the web server should listen on port 80 and hands requests to the upstream nodejs_backend server listening on port 3000. The following three lines are required for websocket connections in nginx version 1.4+</p>

<figure class='code'><figcaption><span>nginx config file</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/puppet/files/nginx.conf'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>proxy_http_version 1.1;
</span><span class='line'>proxy_set_header Upgrade <span class="nv">$http_upgrade</span>;
</span><span class='line'>proxy_set_header Connection <span class="s2">&quot;upgrade&quot;</span>;
</span></code></pre></td></tr></table></div></figure>


<h2>redis config</h2>

<p>The redis config file below ensures that the redis-server is installed and running</p>

<figure class='code'><figcaption><span>redis config file</span><a href='https://github.com/pidah/nodejs_deployment/blob/master/puppet/manifests/redis.pp'>link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>class redis <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    package <span class="o">{</span> <span class="s2">&quot;redis-server&quot;</span>:
</span><span class='line'>            <span class="nv">ensure</span>  <span class="o">=</span>&gt; installed,
</span><span class='line'>            <span class="nv">require</span> <span class="o">=</span>&gt; Class<span class="o">[</span><span class="s2">&quot;Nodejs&quot;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    service <span class="o">{</span> <span class="s1">&#39;redis-server&#39;</span>:
</span><span class='line'>        <span class="nv">ensure</span>     <span class="o">=</span>&gt; running,
</span><span class='line'>        <span class="nb">enable</span>     <span class="o">=</span>&gt; <span class="nb">true</span>,
</span><span class='line'>        <span class="nv">hasrestart</span> <span class="o">=</span>&gt; <span class="nb">true</span>,
</span><span class='line'>        <span class="nv">require</span>    <span class="o">=</span>&gt; Package<span class="o">[</span><span class="s1">&#39;redis-server&#39;</span><span class="o">]</span>,
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deploying the instance</h2>

<p>As described in the <a href="https://github.com/pidah/nodejs_deployment/blob/master/README.md">README.md</a> file, the next step is to launch the instance as follows</p>

<figure class='code'><figcaption><span>launching the instance</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant up --provider<span class="o">=</span>aws
</span></code></pre></td></tr></table></div></figure>


<p>You can then use your regular vagrant commands as usual e.g, to ssh into your instance</p>

<figure class='code'><figcaption><span>login to the instance</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant ssh
</span></code></pre></td></tr></table></div></figure>


<p>You can get the public DNS name of the instance with the <code>vagrant ssh-config</code> command:</p>

<figure class='code'><figcaption><span>get the public dns name of ec2 instance</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vagrant ssh-config
</span><span class='line'>
</span><span class='line'>Host nodejs
</span><span class='line'>  HostName ec2-184-73-111-79.compute-1.amazonaws.com
</span><span class='line'>  User ubuntu
</span><span class='line'>  Port 22
</span><span class='line'>  UserKnownHostsFile /dev/null
</span><span class='line'>  StrictHostKeyChecking no
</span><span class='line'>  PasswordAuthentication no
</span><span class='line'>  IdentityFile <span class="s2">&quot;/Users/Peter/.ssh/development.pem&quot;</span>
</span><span class='line'>  IdentitiesOnly yes
</span><span class='line'>  LogLevel FATAL
</span></code></pre></td></tr></table></div></figure>


<p>You can then access the app from your browser e.g <a href="http://ec2-184-73-111-79.compute-1.amazonaws.com">http://ec2-184-73-111-79.compute-1.amazonaws.com</a> or using curl as shown below:</p>

<figure class='code'><figcaption><span>testing the app with curl</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>curl http://ec2-184-73-111-79.compute-1.amazonaws.com
</span><span class='line'>My awesome node app!<span class="nv">$ </span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all folks. Thanks for dropping by!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Your Name</span></span>

      








  


<time datetime="2013-05-16T18:02:00+01:00" pubdate data-updated="true">May 16<span>th</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://pidah.github.io/blog/2013/05/16/deploying-node-dot-js-plus-nginx-plus-upstart-plus-monit-on-ec2-with-puppet-and-vagrant/" data-via="" data-counturl="http://pidah.github.io/blog/2013/05/16/deploying-node-dot-js-plus-nginx-plus-upstart-plus-monit-on-ec2-with-puppet-and-vagrant/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/05/07/automated-deployment-of-aws-ec2-instances-with-vagrant-and-puppet/" title="Previous Post: Automated deployment of AWS EC2 instances with vagrant and puppet">&laquo; Automated deployment of AWS EC2 instances with vagrant and puppet</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/10/21/devops101-coming-soon/" title="Next Post: DevOps101 coming soon">DevOps101 coming soon &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/10/22/wake-up-the-sun/">Wake Up the Sun</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/21/devops101-coming-soon/">DevOps101 coming soon</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/16/deploying-node-dot-js-plus-nginx-plus-upstart-plus-monit-on-ec2-with-puppet-and-vagrant/">Deploying nodejs nginx upstart monit redis on ec2 with puppet and vagrant</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/07/automated-deployment-of-aws-ec2-instances-with-vagrant-and-puppet/">Automated deployment of AWS EC2 instances with vagrant and puppet</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/05/07/hi/">Hi!</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Your Name -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
